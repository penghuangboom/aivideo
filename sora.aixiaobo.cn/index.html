<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/ims/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AIç”Ÿäº§åŠ› Â· ä¸“ä¸šçš„è§†é¢‘å¤„ç†å¹³å°</title>
    
    <script>
    (function() {
        // 1. ä¿å­˜ Token çš„å·¥å…·å‡½æ•°
        function saveToken(token) {
            if(!token) return;
            localStorage.setItem('sora_auth_token', token);
            document.cookie = `auth_token=${token}; path=/; max-age=86400`;
        }

        // 2. è·å– Token çš„å·¥å…·å‡½æ•°
        function getToken() {
            // ä¼˜å…ˆä» localStorage æ‹¿
            let t = localStorage.getItem('sora_auth_token');
            // æ²¡æœ‰å°±ä» Cookie æ‹¿
            if (!t) {
                const match = document.cookie.match(/auth_token=([^;]+)/);
                if(match) t = match[1];
            }
            // è¿˜æ²¡æœ‰ï¼Ÿçœ‹çœ‹åŸæœ‰çš„ new-api-user
            if (!t) {
                const userId = localStorage.getItem('new-api-user');
                if(userId) t = 'mock-token-' + userId;
            }
            return t;
        }

        // 3. æ‹¦æˆª XMLHttpRequest (Vue Axios åº•å±‚)
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function(method, url) {
            this._url = url; // è®°å½• URL
            return originalOpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function(body) {
            // å¦‚æœæ˜¯å‘ç»™ API çš„è¯·æ±‚ï¼Œä¸”ä¸æ˜¯ç™»å½•/æ³¨å†Œï¼Œå°±æ³¨å…¥ Token
            if (this._url && this._url.includes('/api/') && !this._url.includes('login') && !this._url.includes('register')) {
                const token = getToken();
                if (token) {
                    this.setRequestHeader('Authorization', token);
                }
            }

            // ç›‘å¬å“åº”ï¼šå¦‚æœæ˜¯ç™»å½•æ¥å£ï¼Œä¸”æˆåŠŸäº†ï¼Œå°±æŠ“å– Token
            this.addEventListener('load', function() {
                if (this._url && this._url.includes('/api/user/login')) {
                    try {
                        const res = JSON.parse(this.responseText);
                        if (res.success && res.data && res.data.token) {
                            console.log("ğŸ”“ æ‹¦æˆªå™¨æ•è·ç™»å½• Token:", res.data.token);
                            saveToken(res.data.token);
                        }
                    } catch(e) {}
                }
            });

            return originalSend.apply(this, arguments);
        };
    })();
    </script>

    <script type="module" crossorigin src="/assets/index-InSkuxQ1.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-DGGAWGGh.css">
    <style>
        .hidden-feature { display: none !important; }
        .sora-pro-sidebar-item {
            display: flex; align-items: center; height: 50px; line-height: 50px; padding: 0 20px;
            cursor: pointer; color: #303133; font-size: 14px; font-weight: 500; margin-bottom: 5px;
            transition: 0.2s; border-radius: 4px;
        }
        .sora-pro-sidebar-item:hover { background-color: #ecf5ff; }
        .sora-pro-sidebar-item.active {
            color: #6366f1 !important; background-color: #eef2ff !important; border-right: 3px solid #6366f1; font-weight: 700;
        }
        #sora-pro-view-container { display: none; width: 100%; height: 100%; background: #f9fafb; border: none; }
        #fixed-backup-btn {
            position: fixed; left: 10px; top: 80px; z-index: 99999; padding: 8px 16px;
            background: #6366f1; color: white; border-radius: 20px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 12px rgba(99,102,241,0.4); display: none;
        }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <div id="fixed-backup-btn" onclick="toggleProView(true)">ğŸš€ Sora Pro</div>

    <script>
    (function() {
        const PRO_TITLE = "Sora Pro (é«˜çº§ç‰ˆ)";
        let appMainContainer = null;
        let proIframe = null;
        let lastUrl = window.location.href;

        function isLoginPage() {
            if (window.location.href.includes('/login') || window.location.hash.includes('/login')) return true;
            if (document.querySelector('.login-container') || document.querySelector('.login-card')) return true;
            return false;
        }

        function hideLegacyFeatures() {
            const allElements = document.querySelectorAll('li, .menu-item, span');
            allElements.forEach(el => {
                if (el.innerText && (el.innerText.includes('æ°´å°') || el.innerText.includes('Watermark'))) {
                    const item = el.closest('li') || el.closest('.menu-item');
                    if (item) item.classList.add('hidden-feature');
                }
            });
        }

        window.toggleProView = function(show) {
            if (isLoginPage()) return;
            if (!appMainContainer) {
                const mains = Array.from(document.querySelectorAll('main, section, .app-main, .main-container'));
                appMainContainer = mains.find(el => el.clientWidth > 300) || document.querySelector('#app > div > div:last-child');
            }
            if (!appMainContainer) return window.location.href = '/studio';

            if (!proIframe) {
                proIframe = document.createElement('iframe');
                proIframe.id = 'sora-pro-view-container';
                proIframe.src = '/studio';
                appMainContainer.parentNode.appendChild(proIframe);
            }

            const menuLi = document.getElementById('sora-pro-li');
            if (show) {
                appMainContainer.style.display = 'none';
                proIframe.style.display = 'block';
                document.querySelectorAll('.is-active, .router-link-active').forEach(el => el.classList.remove('is-active', 'router-link-active'));
                if(menuLi) menuLi.classList.add('active');
            } else {
                appMainContainer.style.display = '';
                proIframe.style.display = 'none';
                if(menuLi) menuLi.classList.remove('active');
            }
        };

        function injectSidebar() {
            if (isLoginPage()) {
                const existLi = document.getElementById('sora-pro-li');
                const existBtn = document.getElementById('fixed-backup-btn');
                if (existLi) existLi.style.display = 'none';
                if (existBtn) existBtn.style.display = 'none';
                return;
            }

            hideLegacyFeatures();

            const existLi = document.getElementById('sora-pro-li');
            if (existLi) { existLi.style.display = 'flex'; return; }

            const potentialSidebars = Array.from(document.querySelectorAll('ul, div[class*="menu"]'));
            const sidebar = potentialSidebars.find(el => {
                const rect = el.getBoundingClientRect();
                return rect.left < 50 && rect.width > 100 && rect.width < 300 && el.querySelectorAll('li').length > 0;
            });

            if (sidebar) {
                const li = document.createElement('li');
                li.id = 'sora-pro-li';
                li.className = 'sora-pro-sidebar-item';
                li.innerHTML = `<span style="font-size:18px; margin-right:10px">ğŸš€</span><span>${PRO_TITLE}</span>`;
                li.onclick = (e) => { e.preventDefault(); e.stopPropagation(); window.toggleProView(true); };

                if (sidebar.firstChild) sidebar.insertBefore(li, sidebar.firstChild);
                else sidebar.appendChild(li);
                
                document.getElementById('fixed-backup-btn').style.display = 'none';

                sidebar.addEventListener('click', function(e) {
                    const clickedItem = e.target.closest('li') || e.target.closest('.menu-item');
                    if (clickedItem && clickedItem.id !== 'sora-pro-li') window.toggleProView(false);
                }, true);
            } else {
                const hasMainContent = document.querySelector('main') || document.querySelector('#app');
                if (hasMainContent && !isLoginPage()) {
                    if(!document.getElementById('sora-pro-li')) document.getElementById('fixed-backup-btn').style.display = 'flex';
                } else {
                    document.getElementById('fixed-backup-btn').style.display = 'none';
                }
            }
        }

        setInterval(() => {
            if (window.location.href !== lastUrl) {
                lastUrl = window.location.href;
                window.toggleProView(false);
                injectSidebar();
            }
        }, 300);

        setInterval(injectSidebar, 800);
    })();
    </script>
  </body>
</html>