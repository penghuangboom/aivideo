import{d as K,u as Q,a as Y,b as Z,r as c,p as A,q as ee,A as M,n as N,c as d,e as s,g as i,t as n,w as W,f as $,h as k,v as R,i as O,l as X,m as se,o as u,_ as te}from"./index-InSkuxQ1.js";const oe={class:"login-container"},ae={class:"login-card card glass register-card"},ie={class:"login-header"},le=["src","alt"],re={class:"gradient-text"},ne={class:"platform-desc"},de={key:0,class:"loading-container"},ue={class:"form-row"},ce={class:"form-group"},ge=["placeholder","disabled"],ve={key:0,class:"form-group"},pe=["placeholder","disabled"],me={key:0,class:"form-group inline"},fe={class:"flex-1"},he=["placeholder","disabled"],_e=["disabled"],we={key:0},be={key:1},ye={key:2},Ce={class:"form-row"},Se={class:"form-group"},ke={class:"password-input-wrapper"},Ie=["placeholder","type","disabled"],Pe=["disabled"],Te={key:0},Ue={key:1},xe={class:"input-hint"},Ve={class:"form-group"},Fe={class:"password-input-wrapper"},Ee=["placeholder","type","disabled"],Be=["disabled"],Le={key:0},Me={key:1},Re={class:"form-group"},Ae=["placeholder","disabled"],Ne=["disabled"],De={key:0},We={key:1},$e={class:"links"},Oe=K({__name:"Register",setup(Xe){const{t:e}=Q();function l(r){N.error(r)}function I(r){N.success(r)}const _=se(),P=Y(),y=Z(),m=c(null),D=c(!0),w=c(""),b=c(""),V=c(""),f=c(""),T=c(""),F=c(""),g=c(!1),U=c(!1),h=c(0);let C=null;const E=c(!1),B=c(!1),x=A(()=>{var r;return((r=m.value)==null?void 0:r.email_verification)??!0}),q=A(()=>m.value?m.value.github_oauth||m.value.linuxdo_oauth||m.value.wechat_login||m.value.telegram_oauth||m.value.oidc_enabled:!1);ee(async()=>{try{const r=await M.getSystemStatus();m.value=r,console.log("ðŸ“‹ åŽç«¯ç³»ç»Ÿé…ç½®:",r),console.log("ðŸ“‹ æ˜¯å¦éœ€è¦é‚®ç®±éªŒè¯:",x.value),console.log("ðŸ“‹ æ˜¯å¦æœ‰ç¬¬ä¸‰æ–¹ç™»å½•:",q.value)}catch(r){console.error("èŽ·å–ç³»ç»Ÿé…ç½®å¤±è´¥:",r),N.error("èŽ·å–ç³»ç»Ÿé…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•")}finally{D.value=!1}P.affCode&&(F.value=P.affCode)});const H=A(()=>w.value.trim()!==""&&/.+@.+\..+/.test(b.value)&&h.value===0);async function j(){var r,o;if(!w.value.trim()){l(e("register.pleaseEnterUsername"));return}if(!/.+@.+\..+/.test(b.value)){l(e("register.invalidEmail"));return}if(h.value>0){l(e("register.pleaseWait",{count:h.value}));return}try{U.value=!0;const t=await X.get(`/api/verification?email=${encodeURIComponent(b.value)}&turnstile=`,{headers:{"X-Show-Error":"true"}}).then(a=>a.data);if((t==null?void 0:t.success)===!1){const a=(t==null?void 0:t.message)||"";if(a.includes("å‘é€è¿‡äºŽé¢‘ç¹")||a.includes("è¯·ç­‰å¾…")){const v=a.match(/(\d+)\s*ç§’/),S=v?parseInt(v[1]):60;l(e("register.pleaseWait",{count:S}));return}if(a.includes("email domain name whitelist")||a.includes("not in the whitelist")){l(e("register.emailNotSupported"));return}if(a.includes("é‚®ç®±åœ°å€åˆ«åé™åˆ¶")||a.includes("special symbols")){l(e("register.emailFormatInvalid"));return}l(a||e("register.sendCodeFailed"));return}I(e("register.codeSentSuccess")),z()}catch(t){const a=((o=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:o.message)||(t==null?void 0:t.message)||e("register.sendCodeFailed");if(a.includes("å‘é€è¿‡äºŽé¢‘ç¹")||a.includes("è¯·ç­‰å¾…")){const v=a.match(/(\d+)\s*ç§’/),S=v?parseInt(v[1]):60;l(e("register.pleaseWait",{count:S}));return}a.includes("email domain name whitelist")||a.includes("not in the whitelist")?l(e("register.emailNotSupported")):a.includes("é‚®ç®±åœ°å€åˆ«åé™åˆ¶")||a.includes("special symbols")?l(e("register.emailFormatInvalid")):l(a)}finally{U.value=!1}}function z(){h.value=60,C&&clearInterval(C),C=window.setInterval(()=>{h.value--,h.value<=0&&C&&(clearInterval(C),C=null)},1e3)}async function G(){var r,o;if(!w.value||!f.value||!T.value){l(e("register.pleaseCompleteForm"));return}if(x.value&&(!b.value||!V.value)){l(e("register.pleaseEnterEmailAndCode"));return}if(f.value.length<8){l(e("register.passwordTooShort"));return}if(f.value.length>20){l(e("register.passwordTooLong"));return}if(f.value!==T.value){l(e("register.passwordMismatch"));return}g.value=!0;try{const t={username:w.value,password:f.value,password2:T.value,wechat_verification_code:"",aff_code:F.value||null};x.value&&(t.email=b.value,t.verification_code=V.value);const a=await M.register(t);if((a==null?void 0:a.success)===!1){a.message.includes("ç®¡ç†å‘˜å…³é—­äº†æ–°ç”¨æˆ·æ³¨å†Œ")?l(e("register.registerClosed")):a.message.includes("ç®¡ç†å‘˜å…³é—­äº†é€šè¿‡å¯†ç è¿›è¡Œæ³¨å†Œ")?l(e("register.passwordRegisterClosed")):l(a.message||e("register.registerFailed"));return}I(e("register.registerSuccess")),console.log("æ¸…é™¤æ—§çš„ç”¨æˆ·ID..."),localStorage.removeItem("new-api-user"),sessionStorage.removeItem("new-api-user"),await new Promise(p=>setTimeout(p,300));const v=await X.post("/api/user/login",{username:w.value,password:f.value},{headers:{"X-Show-Error":"true"}}).then(p=>p.data);if(!v.success){l(e("register.autoLoginFailed")),setTimeout(()=>_.push({name:"login"}),1500);return}if(console.log("è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œå“åº”æ•°æ®:",v),!v.data||!v.data.id){l(e("register.loginFailedNoUserId")),setTimeout(()=>_.push({name:"login"}),1500);return}const S=String(v.data.id);localStorage.setItem("new-api-user",S),console.log("âœ… ä»Žç™»å½•å“åº”ä¿å­˜ç”¨æˆ·ID:",S);const L=await M.getUserSelf();if(!L.success||!L.data){l(e("register.getUserInfoFailed")),setTimeout(()=>_.push({name:"login"}),1500);return}console.log("èŽ·å–åˆ°å®Œæ•´ç”¨æˆ·ä¿¡æ¯:",L.data),P.setProfile(L.data,!0);try{const p=await M.getAffCode();p.success&&p.data&&P.setAffCode(p.data)}catch(p){console.warn("èŽ·å–é‚€è¯·ç å¤±è´¥",p)}if(y.config.balanceLimit.minBalance===0){console.log("âœ… ä½™é¢é™åˆ¶ä¸º0ï¼Œç›´æŽ¥è·³è½¬åˆ°ä¸»é¡µ"),I(e("register.redirecting")),setTimeout(()=>{_.push("/generate")},500);return}if(!P.hasLoginPermission){const p=y.config.balanceLimit.warningMessage;console.log("âš ï¸ ç´¯è®¡å……å€¼ä¸è¶³ä¸”ä¸æ˜¯VIP/SVIPï¼Œè·³è½¬åˆ°å……å€¼é¡µé¢"),I(e("register.insufficientBalance",{message:p})),setTimeout(()=>{_.push("/redeem-standalone")},500);return}I(e("register.redirecting")),setTimeout(()=>{_.push("/generate")},500)}catch(t){l(((o=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:o.message)||(t==null?void 0:t.message)||e("register.registerFailed"))}finally{g.value=!1}}function J(){_.push({name:"login"})}return(r,o)=>(u(),d("div",oe,[o[9]||(o[9]=s("div",{class:"bg-orbs"},[s("div",{class:"orb orb-1"}),s("div",{class:"orb orb-2"}),s("div",{class:"orb orb-3"})],-1)),s("div",ae,[s("div",ie,[s("img",{src:i(y).config.logoUrl,alt:i(y).config.systemName,class:"logo glow"},null,8,le),s("h2",re,n(i(y).config.systemName),1),s("p",ne,n(i(y).config.description),1)]),D.value?(u(),d("div",de,[o[8]||(o[8]=s("div",{class:"loading-spinner"},null,-1)),s("p",null,n(i(e)("register.loadingConfig")),1)])):(u(),d("form",{key:1,onSubmit:W(G,["prevent"]),class:"login-form register-form"},[s("div",ue,[s("div",ce,[s("label",null,n(i(e)("register.username")),1),k(s("input",{"onUpdate:modelValue":o[0]||(o[0]=t=>w.value=t),placeholder:i(e)("register.usernamePlaceholder"),disabled:g.value,autocomplete:"off"},null,8,ge),[[R,w.value,void 0,{trim:!0}]])]),x.value?(u(),d("div",ve,[s("label",null,n(i(e)("register.email")),1),k(s("input",{"onUpdate:modelValue":o[1]||(o[1]=t=>b.value=t),placeholder:i(e)("register.emailPlaceholder"),disabled:g.value||U.value,autocomplete:"off",type:"email"},null,8,pe),[[R,b.value,void 0,{trim:!0}]])])):$("",!0)]),x.value?(u(),d("div",me,[s("div",fe,[s("label",null,n(i(e)("register.verificationCode")),1),k(s("input",{"onUpdate:modelValue":o[2]||(o[2]=t=>V.value=t),placeholder:i(e)("register.verificationCodePlaceholder"),disabled:g.value,autocomplete:"off"},null,8,he),[[R,V.value,void 0,{trim:!0}]])]),s("button",{type:"button",class:"btn-secondary btn-code",disabled:U.value||!H.value,onClick:j},[h.value>0?(u(),d("span",we,n(i(e)("register.countdown",{count:h.value})),1)):U.value?(u(),d("span",be,n(i(e)("register.sending")),1)):(u(),d("span",ye,n(i(e)("register.sendCode")),1))],8,_e)])):$("",!0),s("div",Ce,[s("div",Se,[s("label",null,n(i(e)("register.password")),1),s("div",ke,[k(s("input",{"onUpdate:modelValue":o[3]||(o[3]=t=>f.value=t),placeholder:i(e)("register.passwordPlaceholder"),type:E.value?"text":"password",disabled:g.value,autocomplete:"new-password"},null,8,Ie),[[O,f.value,void 0,{trim:!0}]]),s("button",{type:"button",class:"password-toggle",onClick:o[4]||(o[4]=t=>E.value=!E.value),disabled:g.value,tabindex:"-1"},[E.value?(u(),d("span",Te,"ðŸ‘ï¸")):(u(),d("span",Ue,"ðŸ‘ï¸â€ðŸ—¨ï¸"))],8,Pe)]),s("div",xe,n(i(e)("register.passwordHint")),1)]),s("div",Ve,[s("label",null,n(i(e)("register.confirmPassword")),1),s("div",Fe,[k(s("input",{"onUpdate:modelValue":o[5]||(o[5]=t=>T.value=t),placeholder:i(e)("register.confirmPasswordPlaceholder"),type:B.value?"text":"password",disabled:g.value,autocomplete:"new-password"},null,8,Ee),[[O,T.value,void 0,{trim:!0}]]),s("button",{type:"button",class:"password-toggle",onClick:o[6]||(o[6]=t=>B.value=!B.value),disabled:g.value,tabindex:"-1"},[B.value?(u(),d("span",Le,"ðŸ‘ï¸")):(u(),d("span",Me,"ðŸ‘ï¸â€ðŸ—¨ï¸"))],8,Be)])])]),s("div",Re,[s("label",null,n(i(e)("register.inviteCode")),1),k(s("input",{"onUpdate:modelValue":o[7]||(o[7]=t=>F.value=t),placeholder:i(e)("register.inviteCodePlaceholder"),disabled:g.value,autocomplete:"off"},null,8,Ae),[[R,F.value,void 0,{trim:!0}]])]),s("button",{type:"submit",disabled:g.value,class:"btn-primary btn-large"},[g.value?(u(),d("span",We,n(i(e)("register.registering")),1)):(u(),d("span",De,n(i(e)("register.registerButton")),1))],8,Ne)],32)),s("div",$e,[s("a",{onClick:W(J,["prevent"])},n(i(e)("register.goToLogin")),1)])])]))}}),je=te(Oe,[["__scopeId","data-v-290972a4"]]);export{je as default};
